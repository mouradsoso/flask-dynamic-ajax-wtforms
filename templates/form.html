<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Dynamic WTForms Example w/ AJAX request</title>

  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">

 </head>
 <body>
     <div class="container">
        <form method="POST" action="/">

            <ul id="form">
            {% for field_item in form %}
                {% if field_item is iterable %}
                    <li>
                        {{ field_item.label }}
                    </li>
                    <ul id="{{field_item.name}}">
                    {% for field in field_item %}
                        <li>{{field.label}} {{ field }} <span id="{{field_item.name}}" class="btn-add btn-success">Add</span></li>
                    {% endfor %}
                    </ul>
                {% else %}
                    {% if field_item.name=="csrf_token" %}
                        {{ field_item() }}
                    {% else %}
                        <li >{{field_item.label}} {{ field_item() }}</li>
                    {% endif %}
                {% endif %}
            {% endfor %}
            </ul>

            <button type="button" id="submit" class="btn">Submit</button>
        </form>
    </div>

    <div id="status" class="container"></div>


    <script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="//momentjs.com/downloads/moment.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {

            $('button#submit').bind('click', function(){
                $.ajax({
                  type: 'POST',
                  url: $("form").attr("action"),
                  data: $("form").serialize(),
                  success: function(response) { $('div#status').stop(true,true).show().text(Object.values(response)).fadeOut(10000); },
                  error: function (request, status, error) { $('div#status').show().text("Data not saved: " + error) },
                });
            });

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            // initialize add/remove buttons depending on the fields already
            // generated by server
            Object.values(document.querySelectorAll('ul#form ul')).forEach(function(node){
                $('ul#form').find('ul#'+ node.id +' li:not(:last) .btn-add')
                    .removeClass('btn-add').addClass('btn-remove')
                    .removeClass('btn-success').addClass('btn-danger')
                    .html('Remove');
            });

            // code to dynamically add form fields
            $(document).on('click', '.btn-add', function(e)
            {
                e.preventDefault();

                var button_id = $(this).attr('id'),
                    controlForm = $('ul#form'),
                    currentEntry = $(this).parents('ul#'+ button_id + ' li:last'),
                    newEntry = $(currentEntry.clone());

                // clear input field before adding to DOM
                newEntry.find('input').val('');

                // increment id, name attributes for WTForms to pick up the values
                newEntry.find('input').attr("id", function(i, origValue) {
                    return origValue.replace(/(\d)/g, function(a,b) {
                        return +b+1;
                    });
                });

                newEntry.find('input').attr("name", function(i, origValue) {
                    return origValue.replace(/(\d)/g, function(a,b) {
                        return +b+1;
                    });
                });

                // change labels as well for the sake of clarity
                newEntry.find('label').attr("for", function(i, origValue) {
                    return origValue.replace(/(\d)/g, function(a,b) {
                        return +b+1;
                    });
                });

                // check if the label belongs to an embedded form
                // i.e., if it's parent is a <th>
                // if so, dont use the text from 'for' attr
                newEntry.find('label').text(function(i, oldText) {
                    if ($(this).parent().prop("tagName") === "TH") {
                        return oldText;
                    }

                    else{
                        return capitalizeFirstLetter($(this).attr("for"));
                    }

                });

                newEntry.appendTo($('ul#form ul#'+ button_id));

                controlForm.find('ul#'+ button_id +' li:not(:last) .btn-add')
                    .removeClass('btn-add').addClass('btn-remove')
                    .removeClass('btn-success').addClass('btn-danger')
                    .html('Remove');
            }).on('click', '.btn-remove', function(e)
            {
              var button_id = $(this).attr('id');
              $(this).parents('ul#'+ button_id +' li:first').remove();

              e.preventDefault();
              return false;
            });

        });
    </script>
 </body>
</html>
